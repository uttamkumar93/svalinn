// SPDX-License-Identifier: MIT OR AGPL-3.0-or-later
= Doctor + Onboarding Implementation Plan
:toc: preamble
:toclevels: 3
:icons: font

This document outlines the implementation plan for five critical user experience and distribution features for the Svalinn/Vordr ecosystem.

== Executive Summary

[cols="1,2,1",options="header"]
|===
|Feature Area |Description |Priority

|*1. Doctor Command*
|One-command system validation with fix-forward guidance
|P0 (Critical)

|*2. Release Distribution*
|Prebuilt binaries, checksums, install script
|P0 (Critical)

|*3. CLI UX Parity*
|Consistent flags, output formats, exit codes, errors
|P1 (High)

|*4. Integration Tests*
|README happy path CI validation
|P0 (Critical)

|*5. Config + Defaults*
|XDG-compliant configuration with sane defaults
|P1 (High)
|===

== Feature 1: Doctor + Fix-Forward Onboarding

=== Overview

The `vordr doctor` (aliased as `svalinn doctor`) command performs comprehensive system validation and provides actionable fix-forward guidance.

=== Implementation

==== New File: `vordr/src/cli/doctor.rs`

[source,rust]
----
pub struct DoctorArgs {
    /// Show all checks, not just failures
    #[arg(long)]
    pub all: bool,

    /// Output format (human, json)
    #[arg(long, default_value = "human")]
    pub format: OutputFormat,

    /// Automatically fix issues where possible
    #[arg(long)]
    pub fix: bool,
}
----

==== Check Categories

===== 1. OCI Runtime Availability

[cols="1,2,2",options="header"]
|===
|Check |Validation |Fix-Forward

|youki binary
|`which youki` or config path exists
|`cargo install youki` or package manager command

|runc fallback
|`which runc` if youki missing
|`apt/dnf install runc` based on distro detection

|Runtime version
|Minimum version requirements
|Upgrade command with specific version

|Runtime execution
|Can spawn test container
|Permission/capability guidance
|===

===== 2. Networking Backend (Netavark)

[cols="1,2,2",options="header"]
|===
|Check |Validation |Fix-Forward

|netavark binary
|`which netavark`
|`cargo install netavark` or package command

|netavark version
|Minimum version (1.0+)
|Upgrade instructions

|aardvark-dns (optional)
|DNS resolution support
|Install command for DNS resolution

|Network namespace
|Can create netns
|Kernel module or permission guidance
|===

===== 3. Kernel/Cgroup/Userns Prerequisites

[cols="1,2,2",options="header"]
|===
|Check |Validation |Fix-Forward

|Kernel version
|≥ 5.10 recommended
|Upgrade kernel or note limitations

|cgroup v2
|`/sys/fs/cgroup/cgroup.controllers` exists
|Mount instructions or boot param

|User namespaces
|`/proc/sys/kernel/unprivileged_userns_clone`
|`sysctl -w kernel.unprivileged_userns_clone=1`

|Overlay FS
|Check `/proc/filesystems` for overlay
|Kernel module loading guidance

|Seccomp
|`/proc/self/seccomp` exists
|Kernel config guidance

|Capabilities
|CAP_SYS_ADMIN available (or rootless mode)
|setcap or rootless setup instructions
|===

===== 4. State Database

[cols="1,2,2",options="header"]
|===
|Check |Validation |Fix-Forward

|DB directory
|`/var/lib/vordr` exists and writable
|`mkdir -p` with correct permissions

|DB file
|SQLite can open/create
|Permission fix or path change

|WAL mode
|PRAGMA query succeeds
|Fallback to DELETE mode instructions

|NFS detection
|Detect NFS mount for WAL concerns
|Recommend DELETE journal mode
|===

===== 5. Gatekeeper (SPARK)

[cols="1,2,2",options="header"]
|===
|Check |Validation |Fix-Forward

|Gatekeeper loaded
|FFI call succeeds
|Build instructions or binary distribution

|SPARK toolchain (optional)
|gnatprove available
|GNAT Community Edition install
|===

==== Output Format

===== Human-Readable (default)

[source,text]
----
VORDR SYSTEM CHECK
==================

Runtime
  ✓ youki 0.3.0 found at /usr/local/bin/youki
  ✓ Runtime can spawn containers

Networking
  ✓ netavark 1.9.0 found at /usr/local/bin/netavark
  ⚠ aardvark-dns not found (DNS resolution will be limited)
    → Install: cargo install aardvark-dns

Kernel/Rootless
  ✓ Kernel 6.1.0 (recommended: 5.10+)
  ✓ cgroup v2 unified hierarchy
  ✓ User namespaces enabled
  ✗ Unprivileged user namespaces disabled
    → Fix: sudo sysctl -w kernel.unprivileged_userns_clone=1
    → Persist: echo 'kernel.unprivileged_userns_clone=1' | sudo tee /etc/sysctl.d/99-userns.conf

State Database
  ✓ /var/lib/vordr exists (writable)
  ✓ Database initialized with WAL mode

Gatekeeper
  ✓ Gatekeeper v1.0.0 loaded (SPARK verification enabled)

─────────────────────────────────────────
SUMMARY: 1 error, 1 warning, 8 passed

DO THIS NEXT:
  sudo sysctl -w kernel.unprivileged_userns_clone=1
----

===== JSON Output

[source,json]
----
{
  "version": "0.1.0",
  "timestamp": "2025-01-15T10:30:00Z",
  "checks": [
    {
      "category": "runtime",
      "name": "youki_binary",
      "status": "pass",
      "message": "youki 0.3.0 found at /usr/local/bin/youki"
    },
    {
      "category": "kernel",
      "name": "unprivileged_userns",
      "status": "fail",
      "message": "Unprivileged user namespaces disabled",
      "fix": {
        "command": "sudo sysctl -w kernel.unprivileged_userns_clone=1",
        "persist": "echo 'kernel.unprivileged_userns_clone=1' | sudo tee /etc/sysctl.d/99-userns.conf"
      }
    }
  ],
  "summary": {
    "passed": 8,
    "warnings": 1,
    "errors": 1
  },
  "next_steps": [
    "sudo sysctl -w kernel.unprivileged_userns_clone=1"
  ]
}
----

==== Auto-Fix Mode (`--fix`)

When `--fix` is passed, automatically execute fixes where safe:

* Create missing directories
* Set file permissions
* Initialize database
* Download missing binaries (with confirmation)

Unsafe operations (sysctl changes, kernel modules) provide copy/paste commands only.

=== CLI Registration

Add to `vordr/src/cli/mod.rs`:

[source,rust]
----
pub mod doctor;

#[derive(Subcommand, Debug)]
pub enum Commands {
    // ... existing commands ...

    /// Check system prerequisites and configuration
    Doctor(doctor::DoctorArgs),

    // Alias for svalinn branding
    #[command(hide = true)]
    Check(doctor::DoctorArgs),
}
----

=== Files to Create/Modify

* `vordr/src/cli/doctor.rs` (new) - Doctor command implementation
* `vordr/src/cli/mod.rs` - Add Doctor command
* `vordr/src/system/mod.rs` (new) - System detection utilities
* `vordr/src/system/distro.rs` (new) - Linux distro detection
* `vordr/src/system/kernel.rs` (new) - Kernel feature detection
* `vordr/src/system/runtime.rs` (new) - OCI runtime detection

== Feature 2: Release-Grade Distribution

=== Overview

Provide prebuilt binaries, checksums, signatures, and installation scripts for easy adoption.

=== Binary Distribution

==== Platforms

[cols="1,1,1",options="header"]
|===
|Platform |Target |Notes

|Linux x86_64
|`x86_64-unknown-linux-gnu`
|Primary target, glibc 2.31+

|Linux x86_64 (musl)
|`x86_64-unknown-linux-musl`
|Static binary, maximum compatibility

|Linux aarch64
|`aarch64-unknown-linux-gnu`
|ARM64 servers, Raspberry Pi 4+

|Linux aarch64 (musl)
|`aarch64-unknown-linux-musl`
|Static ARM64 binary
|===

==== Build Matrix (GitHub Actions)

[source,yaml]
----
# .github/workflows/release.yml
name: Release

on:
  push:
    tags: ['v*']

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            name: vordr-linux-x86_64
          - target: x86_64-unknown-linux-musl
            os: ubuntu-22.04
            name: vordr-linux-x86_64-musl
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            name: vordr-linux-aarch64
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
            name: vordr-linux-aarch64-musl
            cross: true
----

=== Security Artifacts

==== Checksums

[source,text]
----
# SHA256SUMS
a1b2c3d4...  vordr-linux-x86_64
e5f6g7h8...  vordr-linux-x86_64-musl
i9j0k1l2...  vordr-linux-aarch64
m3n4o5p6...  vordr-linux-aarch64-musl
----

==== GPG Signatures

* Sign checksums file with project key
* Publish public key in repository and keyservers
* Document verification steps

==== SLSA Provenance (Future)

* Generate SLSA attestations for supply chain security
* Publish to Sigstore transparency log

=== Install Script

[source,bash]
----
#!/usr/bin/env bash
# SPDX-License-Identifier: MIT OR AGPL-3.0-or-later
# Vordr Quick Install Script
# Usage: curl -fsSL https://get.vordr.dev | bash

set -euo pipefail

VERSION="${VORDR_VERSION:-latest}"
INSTALL_DIR="${VORDR_INSTALL_DIR:-/usr/local/bin}"

detect_platform() {
    local arch
    arch=$(uname -m)
    case "$arch" in
        x86_64)  echo "x86_64" ;;
        aarch64) echo "aarch64" ;;
        arm64)   echo "aarch64" ;;
        *)       echo "Unsupported architecture: $arch" >&2; exit 1 ;;
    esac
}

detect_variant() {
    # Prefer musl for maximum compatibility
    if ldd --version 2>&1 | grep -q musl; then
        echo "musl"
    elif [ -f /etc/alpine-release ]; then
        echo "musl"
    else
        echo "gnu"
    fi
}

main() {
    local platform variant binary_name url
    platform=$(detect_platform)
    variant=$(detect_variant)

    if [ "$variant" = "musl" ]; then
        binary_name="vordr-linux-${platform}-musl"
    else
        binary_name="vordr-linux-${platform}"
    fi

    echo "Installing Vordr ($platform, $variant)..."

    if [ "$VERSION" = "latest" ]; then
        url="https://github.com/hyperpolymath/svalinn/releases/latest/download/${binary_name}"
    else
        url="https://github.com/hyperpolymath/svalinn/releases/download/${VERSION}/${binary_name}"
    fi

    # Download binary
    curl -fsSL "$url" -o /tmp/vordr

    # Verify checksum
    curl -fsSL "${url}.sha256" -o /tmp/vordr.sha256
    echo "$(cat /tmp/vordr.sha256)  /tmp/vordr" | sha256sum -c -

    # Install
    sudo install -m 755 /tmp/vordr "$INSTALL_DIR/vordr"

    echo "Vordr installed to $INSTALL_DIR/vordr"
    echo "Run 'vordr doctor' to verify your system"
}

main "$@"
----

=== Package Distribution (Future)

* Guix package definition
* Nix flake
* AUR package
* Homebrew formula (for macOS if supported)

=== Files to Create/Modify

* `.github/workflows/release.yml` (new) - Release automation
* `scripts/install.sh` (new) - Install script
* `scripts/checksum.sh` (new) - Checksum generation
* `INSTALL.adoc` (new) - Installation documentation

== Feature 3: CLI UX Parity

=== Overview

Ensure the core container loop (`pull`, `run`, `ps`, `exec`, `stop`, `rm`) is pleasant with consistent output, flags, and errors.

=== Output Formatting

==== Table Output (Default)

[source,text]
----
$ vordr ps
CONTAINER ID   IMAGE          COMMAND     STATUS         PORTS                   NAMES
a1b2c3d4e5f6   alpine:3.18    /bin/sh     Up 2 hours     0.0.0.0:8080->80/tcp    web-server
g7h8i9j0k1l2   redis:7        redis-ser   Up 30 min                              cache
----

==== JSON Output (`--json`)

[source,json]
----
$ vordr ps --json
[
  {
    "id": "a1b2c3d4e5f6",
    "image": "alpine:3.18",
    "command": "/bin/sh",
    "status": "running",
    "created": "2025-01-15T08:30:00Z",
    "ports": [{"host": 8080, "container": 80, "protocol": "tcp"}],
    "names": ["web-server"]
  }
]
----

==== Stable Schema Contract

Document JSON schema version and maintain backwards compatibility:

[source,json]
----
{
  "$schema": "https://vordr.dev/schemas/ps-v1.json",
  "version": 1,
  "containers": [...]
}
----

=== Consistent Flags

==== Global Flags

[cols="1,2,1",options="header"]
|===
|Flag |Description |Default

|`--json`
|Output in JSON format
|false

|`--quiet`, `-q`
|Only show IDs
|false

|`--verbose`, `-v`
|Enable verbose output
|false

|`--debug`
|Enable debug output (includes tracing)
|false
|===

==== Container Flags (Standardized)

[cols="1,2",options="header"]
|===
|Flag |Description

|`--name NAME`
|Container name

|`-i, --interactive`
|Keep STDIN open

|`-t, --tty`
|Allocate pseudo-TTY

|`--rm`
|Remove container on exit

|`-d, --detach`
|Run in background

|`-p, --publish HOST:CONTAINER`
|Publish port

|`-v, --volume HOST:CONTAINER`
|Mount volume

|`-e, --env KEY=VALUE`
|Set environment variable

|`--entrypoint CMD`
|Override entrypoint

|`-w, --workdir DIR`
|Working directory
|===

=== Exit Codes

[cols="1,2",options="header"]
|===
|Code |Meaning

|0
|Success

|1
|General error

|125
|Container engine failure

|126
|Command cannot execute

|127
|Command not found (in container)

|128+N
|Container killed by signal N

|137
|Container killed (SIGKILL)

|143
|Container terminated (SIGTERM)
|===

=== Helpful Error Messages

==== Runtime Not Found

[source,text]
----
Error: Container runtime not found

Looking for: youki, runc
Searched: /usr/local/bin, /usr/bin, $PATH

To fix:
  1. Install youki:  cargo install youki
  2. Or install runc: sudo apt install runc
  3. Or specify path: vordr --runtime /path/to/runtime run ...

Run 'vordr doctor' for full system check
----

==== Netavark Misconfigured

[source,text]
----
Error: Network setup failed

Netavark returned error: bridge device 'vordr0' creation failed

Possible causes:
  - Network namespace permissions (try as root or with newuidmap)
  - Missing kernel module: bridge (run: sudo modprobe bridge)
  - Conflicting bridge name (check: ip link show)

To debug:
  vordr network ls --json | jq
  netavark --debug ...

Run 'vordr doctor' for full system check
----

==== Permission Denied

[source,text]
----
Error: Permission denied creating container

Path: /var/lib/vordr/containers/a1b2c3d4
User: myuser (uid=1000)
Required: Write access to /var/lib/vordr

To fix:
  1. Run as root: sudo vordr run ...
  2. Or set up rootless mode:
     mkdir -p ~/.local/share/vordr
     vordr --root ~/.local/share/vordr run ...
  3. Or fix permissions:
     sudo chown -R 1000:1000 /var/lib/vordr

Run 'vordr doctor' for full system check
----

=== Files to Create/Modify

* `vordr/src/output/mod.rs` (new) - Output formatting module
* `vordr/src/output/table.rs` (new) - Table formatter
* `vordr/src/output/json.rs` (new) - JSON formatter
* `vordr/src/errors/mod.rs` (new) - Error types with context
* `vordr/src/errors/hints.rs` (new) - Error hints/suggestions
* Modify all CLI commands to use consistent output

== Feature 4: Integration Tests

=== Overview

CI validation of the README quick-start flow on clean runners.

=== Test Categories

==== Happy Path Tests

[source,rust]
----
// tests/integration/happy_path.rs

#[tokio::test]
async fn test_readme_quick_start() {
    // Pull image
    let output = Command::new("vordr")
        .args(["pull", "alpine:latest"])
        .output()
        .expect("pull should succeed");
    assert!(output.status.success());

    // Run container
    let output = Command::new("vordr")
        .args(["run", "--name", "test-container", "-d", "alpine:latest", "sleep", "300"])
        .output()
        .expect("run should succeed");
    assert!(output.status.success());

    // List containers
    let output = Command::new("vordr")
        .args(["ps"])
        .output()
        .expect("ps should succeed");
    assert!(output.status.success());
    assert!(String::from_utf8_lossy(&output.stdout).contains("test-container"));

    // Exec in container
    let output = Command::new("vordr")
        .args(["exec", "test-container", "echo", "hello"])
        .output()
        .expect("exec should succeed");
    assert!(output.status.success());
    assert!(String::from_utf8_lossy(&output.stdout).contains("hello"));

    // Stop container
    let output = Command::new("vordr")
        .args(["stop", "test-container"])
        .output()
        .expect("stop should succeed");
    assert!(output.status.success());

    // Remove container
    let output = Command::new("vordr")
        .args(["rm", "test-container"])
        .output()
        .expect("rm should succeed");
    assert!(output.status.success());
}
----

==== Networking Tests

[source,rust]
----
#[tokio::test]
async fn test_container_networking() {
    // Create network
    Command::new("vordr")
        .args(["network", "create", "test-net"])
        .assert()
        .success();

    // Run container on network
    Command::new("vordr")
        .args(["run", "--name", "net-test", "--network", "test-net", "-d", "alpine", "sleep", "60"])
        .assert()
        .success();

    // Verify IP assignment
    let output = Command::new("vordr")
        .args(["inspect", "net-test", "--format", "{{.NetworkSettings.IPAddress}}"])
        .output()
        .unwrap();
    let ip = String::from_utf8_lossy(&output.stdout);
    assert!(ip.starts_with("10.") || ip.starts_with("172."));

    // Cleanup
    Command::new("vordr").args(["rm", "-f", "net-test"]).ok();
    Command::new("vordr").args(["network", "rm", "test-net"]).ok();
}
----

==== Registry Auth Tests

[source,rust]
----
#[tokio::test]
async fn test_private_registry_auth() {
    // Set credentials (via config file in test fixture)
    std::env::set_var("VORDR_CONFIG", "tests/fixtures/auth-config.toml");

    // Pull from private registry (using test registry)
    let output = Command::new("vordr")
        .args(["pull", "localhost:5000/private-image:latest"])
        .output()
        .unwrap();

    // Should succeed with valid auth
    assert!(output.status.success());
}
----

=== CI Configuration

[source,yaml]
----
# .github/workflows/integration.yml
name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  integration:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install dependencies
        run: |
          # Install youki
          cargo install youki

          # Install netavark
          cargo install netavark

          # Enable user namespaces
          sudo sysctl -w kernel.unprivileged_userns_clone=1

      - name: Build Vordr
        run: just build-vordr-quick

      - name: Run doctor check
        run: ./target/release/vordr doctor

      - name: Run integration tests
        run: cargo test --test integration -- --test-threads=1

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: /var/lib/vordr/
----

=== Files to Create/Modify

* `vordr/tests/integration/mod.rs` (new) - Integration test module
* `vordr/tests/integration/happy_path.rs` (new) - README flow tests
* `vordr/tests/integration/networking.rs` (new) - Network tests
* `vordr/tests/integration/registry.rs` (new) - Registry auth tests
* `vordr/tests/integration/lifecycle.rs` (new) - Container lifecycle tests
* `vordr/tests/fixtures/` (new) - Test fixtures directory
* `.github/workflows/integration.yml` (new) - CI workflow

== Feature 5: Stable Config + Sane Defaults

=== Overview

XDG-compliant configuration with clear state management and config commands.

=== Directory Structure

==== XDG Base Directory Compliance

[cols="1,1,2",options="header"]
|===
|XDG Variable |Default Path |Vordr Usage

|`XDG_CONFIG_HOME`
|`~/.config`
|`~/.config/vordr/config.toml`

|`XDG_DATA_HOME`
|`~/.local/share`
|`~/.local/share/vordr/` (containers, images)

|`XDG_STATE_HOME`
|`~/.local/state`
|`~/.local/state/vordr/` (logs, db)

|`XDG_RUNTIME_DIR`
|`/run/user/$UID`
|`/run/user/$UID/vordr/` (sockets, PIDs)
|===

==== System-Wide Paths (Root Mode)

[cols="1,2",options="header"]
|===
|Path |Purpose

|`/etc/vordr/config.toml`
|System configuration

|`/var/lib/vordr/`
|Container/image storage

|`/var/lib/vordr/vordr.db`
|State database

|`/var/log/vordr/`
|System logs

|`/run/vordr/`
|Runtime sockets
|===

=== Configuration File Format

[source,toml]
----
# /etc/vordr/config.toml or ~/.config/vordr/config.toml
# SPDX-License-Identifier: MIT OR AGPL-3.0-or-later

[engine]
# Container runtime binary (youki or runc)
runtime = "youki"
# Alternative: explicit path
# runtime = "/usr/local/bin/youki"

# Root directory for container state
root = "/var/lib/vordr"

# Database path
db = "/var/lib/vordr/vordr.db"

# Database journal mode (wal or delete)
# Use "delete" for NFS mounts
journal_mode = "wal"

[runtime]
# Default stop timeout in seconds
stop_timeout = 10

# Default cgroup driver (cgroupfs or systemd)
cgroup_driver = "systemd"

# Enable user namespace remapping
userns = true

# Default seccomp profile (path or "default")
seccomp = "default"

[network]
# Network backend (netavark)
driver = "netavark"

# Path to netavark binary
netavark_path = "/usr/local/bin/netavark"

# Path to aardvark-dns binary (optional)
aardvark_dns_path = "/usr/local/bin/aardvark-dns"

# Default network subnet
default_subnet = "10.89.0.0/24"

# DNS servers for containers
dns = ["1.1.1.1", "8.8.8.8"]

[registry]
# Default registry for unqualified images
default = "docker.io"

# Mirror registries (tried in order)
mirrors = []

# Credential store (file, keyring, none)
credential_store = "file"

# Insecure registries (HTTP allowed)
insecure = []

[auth]
# Path to auth file (~/.config/vordr/auth.json)
auth_file = ""

[[registry.credentials]]
registry = "docker.io"
# Credentials from: auth_file, environment, or specified here
# username = ""
# password = ""

[logging]
# Log level (error, warn, info, debug, trace)
level = "info"

# Log format (text, json)
format = "text"

# Log output (stderr, file, syslog)
output = "stderr"

# Log file path (when output = "file")
file = ""
----

=== Config Commands

==== `vordr config show`

Display current effective configuration:

[source,text]
----
$ vordr config show
Configuration: /etc/vordr/config.toml

engine.runtime = "youki"
engine.root = "/var/lib/vordr"
engine.db = "/var/lib/vordr/vordr.db"
network.driver = "netavark"
network.default_subnet = "10.89.0.0/24"
...

Sources:
  /etc/vordr/config.toml (system)
  Environment variables: VORDR_RUNTIME, VORDR_ROOT
----

==== `vordr config validate`

Validate configuration file syntax and values:

[source,text]
----
$ vordr config validate
Checking: /etc/vordr/config.toml

  ✓ TOML syntax valid
  ✓ engine.runtime: youki found at /usr/local/bin/youki
  ✓ engine.root: /var/lib/vordr exists and writable
  ⚠ network.aardvark_dns_path: not found (DNS resolution limited)
  ✓ registry.default: docker.io reachable

Configuration valid (1 warning)
----

==== `vordr config edit`

Open config file in `$EDITOR`:

[source,bash]
----
$ vordr config edit
# Opens /etc/vordr/config.toml or ~/.config/vordr/config.toml in $EDITOR
----

==== `vordr config reset`

Reset to defaults:

[source,bash]
----
$ vordr config reset
Reset configuration to defaults? [y/N] y
Created: ~/.config/vordr/config.toml (from defaults)
----

==== `vordr config path`

Show configuration file locations:

[source,text]
----
$ vordr config path
System config: /etc/vordr/config.toml (not found)
User config:   ~/.config/vordr/config.toml (active)
Data dir:      ~/.local/share/vordr
State dir:     ~/.local/state/vordr
Runtime dir:   /run/user/1000/vordr
----

=== State Management

==== `vordr system prune`

Clean up unused resources:

[source,bash]
----
$ vordr system prune
This will remove:
  - All stopped containers
  - All unused networks
  - All unused volumes
  - All dangling images

Space to reclaim: 2.3 GB

Continue? [y/N] y
Deleted: 5 containers, 2 networks, 1 volume, 12 images
Reclaimed: 2.3 GB
----

==== `vordr system reset`

Full reset (with confirmation):

[source,bash]
----
$ vordr system reset
WARNING: This will delete ALL Vordr data:
  - All containers (running and stopped)
  - All images
  - All networks
  - All volumes
  - Configuration (optional)

Type 'yes' to confirm: yes
Stopping 2 running containers...
Removing all data from /var/lib/vordr...
Reset complete. Run 'vordr doctor' to verify.
----

=== Files to Create/Modify

* `vordr/src/config/mod.rs` (new) - Configuration module
* `vordr/src/config/file.rs` (new) - TOML config parsing
* `vordr/src/config/defaults.rs` (new) - Default values
* `vordr/src/config/xdg.rs` (new) - XDG path resolution
* `vordr/src/cli/config.rs` (new) - Config subcommands
* `vordr/src/cli/system.rs` (new) - System subcommands
* `vordr/src/cli/mod.rs` - Add Config and System commands
* `config/vordr.example.toml` (new) - Example config file

== Implementation Order

=== Phase 1: Foundation (v0.2.0)

1. *Config system* - Implement XDG-compliant configuration
2. *Error framework* - Implement helpful error messages
3. *Output formatting* - Implement table + JSON output

=== Phase 2: Doctor (v0.2.0)

1. *System detection* - Distro, kernel, capabilities
2. *Doctor checks* - All check categories
3. *Fix-forward* - Actionable guidance

=== Phase 3: Distribution (v0.2.0)

1. *Release workflow* - GitHub Actions matrix build
2. *Install script* - curl | bash installer
3. *Checksums/signatures* - Security artifacts

=== Phase 4: Testing (v0.2.0)

1. *Test infrastructure* - Integration test framework
2. *Happy path tests* - README flow validation
3. *CI integration* - Run tests on clean runners

=== Phase 5: Polish (v0.3.0)

1. *CLI flag consistency* - Audit and standardize
2. *Exit codes* - Implement proper exit codes
3. *Documentation* - Update README and add INSTALL.adoc

== Success Criteria

=== Doctor Command

* [ ] `vordr doctor` runs without error on clean Ubuntu 22.04
* [ ] Detects missing dependencies with clear fix instructions
* [ ] JSON output parseable by automation tools
* [ ] `--fix` mode handles safe auto-fixes

=== Release Distribution

* [ ] Prebuilt binaries for x86_64 and aarch64
* [ ] SHA256 checksums for all binaries
* [ ] Install script works on Ubuntu, Debian, Fedora, Arch
* [ ] Binary size < 20MB (static linked)

=== CLI UX

* [ ] All commands support `--json`
* [ ] Exit codes match Docker conventions
* [ ] Error messages include "Do this next" suggestions
* [ ] `--help` comprehensive for all commands

=== Integration Tests

* [ ] README quick-start passes in CI
* [ ] Network tests pass in rootless mode
* [ ] Tests complete in < 5 minutes

=== Configuration

* [ ] XDG paths used correctly
* [ ] `config show/validate/edit` work
* [ ] Environment variables override config file
* [ ] Rootless mode works with user-level paths

== References

* https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html[XDG Base Directory Specification]
* https://docs.docker.com/engine/reference/commandline/cli/[Docker CLI Reference]
* https://github.com/containers/podman[Podman - Container Engine]
* https://rust-cli.github.io/book/[Rust CLI Book]
